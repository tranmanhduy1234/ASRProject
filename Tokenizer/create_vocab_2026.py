import sentencepiece as spm #type: ignore
import numpy as np
control_tokens = [
    "<|vitranscript|>", "<|entranslate|>",
    "<start_speech>", "<end_speech>",
    "<ts_0.00>", 
    "<ts_0.05>", 
    "<ts_0.10>",
    "<ts_0.15>",
    "<ts_0.20>",
    "<ts_0.25>",
    "<ts_0.30>",
    "<ts_0.35>",
    "<ts_0.40>",
    "<ts_0.45>",
    "<ts_0.50>",
    "<ts_0.55>",
    "<ts_0.60>",
    "<ts_0.65>",
    "<ts_0.70>",
    "<ts_0.75>",
    "<ts_0.80>",
    "<ts_0.85>",
    "<ts_0.90>",
    "<ts_0.95>",
    "<ts_1.00>",
    "<ts_1.05>",
    "<ts_1.10>",
    "<ts_1.15>",
    "<ts_1.20>",
    "<ts_1.25>",
    "<ts_1.30>",
    "<ts_1.35>",
    "<ts_1.40>",
    "<ts_1.45>",
    "<ts_1.50>",
    "<ts_1.55>",
    "<ts_1.60>",
    "<ts_1.65>",
    "<ts_1.70>",
    "<ts_1.75>",
    "<ts_1.80>",
    "<ts_1.85>",
    "<ts_1.90>",
    "<ts_1.95>",
    "<ts_2.00>",
    "<ts_2.05>",
    "<ts_2.10>",
    "<ts_2.15>",
    "<ts_2.20>",
    "<ts_2.25>",
    "<ts_2.30>",
    "<ts_2.35>",
    "<ts_2.40>",
    "<ts_2.45>",
    "<ts_2.50>",
    "<ts_2.55>",
    "<ts_2.60>",
    "<ts_2.65>",
    "<ts_2.70>",
    "<ts_2.75>",
    "<ts_2.80>",
    "<ts_2.85>",
    "<ts_2.90>",
    "<ts_2.95>",
    "<ts_3.00>",
    "<ts_3.05>",
    "<ts_3.10>",
    "<ts_3.15>",
    "<ts_3.20>",
    "<ts_3.25>",
    "<ts_3.30>",
    "<ts_3.35>",
    "<ts_3.40>",
    "<ts_3.45>",
    "<ts_3.50>",
    "<ts_3.55>",
    "<ts_3.60>",
    "<ts_3.65>",
    "<ts_3.70>",
    "<ts_3.75>",
    "<ts_3.80>",
    "<ts_3.85>",
    "<ts_3.90>",
    "<ts_3.95>",
    "<ts_4.00>",
    "<ts_4.05>",
    "<ts_4.10>",
    "<ts_4.15>",
    "<ts_4.20>",
    "<ts_4.25>",
    "<ts_4.30>",
    "<ts_4.35>",
    "<ts_4.40>",
    "<ts_4.45>",
    "<ts_4.50>",
    "<ts_4.55>",
    "<ts_4.60>",
    "<ts_4.65>",
    "<ts_4.70>",
    "<ts_4.75>",
    "<ts_4.80>",
    "<ts_4.85>",
    "<ts_4.90>",
    "<ts_4.95>",
    "<ts_5.00>",
    "<ts_5.05>",
    "<ts_5.10>",
    "<ts_5.15>",
    "<ts_5.20>",
    "<ts_5.25>",
    "<ts_5.30>",
    "<ts_5.35>",
    "<ts_5.40>",
    "<ts_5.45>",
    "<ts_5.50>",
    "<ts_5.55>",
    "<ts_5.60>",
    "<ts_5.65>",
    "<ts_5.70>",
    "<ts_5.75>",
    "<ts_5.80>",
    "<ts_5.85>",
    "<ts_5.90>",
    "<ts_5.95>",
    "<ts_6.00>",
    "<ts_6.05>",
    "<ts_6.10>",
    "<ts_6.15>",
    "<ts_6.20>",
    "<ts_6.25>",
    "<ts_6.30>",
    "<ts_6.35>",
    "<ts_6.40>",
    "<ts_6.45>",
    "<ts_6.50>",
    "<ts_6.55>",
    "<ts_6.60>",
    "<ts_6.65>",
    "<ts_6.70>",
    "<ts_6.75>",
    "<ts_6.80>",
    "<ts_6.85>",
    "<ts_6.90>",
    "<ts_6.95>",
    "<ts_7.00>",
    "<ts_7.05>",
    "<ts_7.10>",
    "<ts_7.15>",
    "<ts_7.20>",
    "<ts_7.25>",
    "<ts_7.30>",
    "<ts_7.35>",
    "<ts_7.40>",
    "<ts_7.45>",
    "<ts_7.50>",
    "<ts_7.55>",
    "<ts_7.60>",
    "<ts_7.65>",
    "<ts_7.70>",
    "<ts_7.75>",
    "<ts_7.80>",
    "<ts_7.85>",
    "<ts_7.90>",
    "<ts_7.95>",
    "<ts_8.00>",
    "<ts_8.05>",
    "<ts_8.10>",
    "<ts_8.15>",
    "<ts_8.20>",
    "<ts_8.25>",
    "<ts_8.30>",
    "<ts_8.35>",
    "<ts_8.40>",
    "<ts_8.45>",
    "<ts_8.50>",
    "<ts_8.55>",
    "<ts_8.60>",
    "<ts_8.65>",
    "<ts_8.70>",
    "<ts_8.75>",
    "<ts_8.80>",
    "<ts_8.85>",
    "<ts_8.90>",
    "<ts_8.95>",
    "<ts_9.00>",
    "<ts_9.05>",
    "<ts_9.10>",
    "<ts_9.15>",
    "<ts_9.20>",
    "<ts_9.25>",
    "<ts_9.30>",
    "<ts_9.35>",
    "<ts_9.40>",
    "<ts_9.45>",
    "<ts_9.50>",
    "<ts_9.55>",
    "<ts_9.60>",
    "<ts_9.65>",
    "<ts_9.70>",
    "<ts_9.75>",
    "<ts_9.80>",
    "<ts_9.85>",
    "<ts_9.90>",
    "<ts_9.95>",
    "<ts_10.00>",
    "<ts_10.05>",
    "<ts_10.10>",
    "<ts_10.15>",
    "<ts_10.20>",
    "<ts_10.25>",
    "<ts_10.30>",
    "<ts_10.35>",
    "<ts_10.40>",
    "<ts_10.45>",
    "<ts_10.50>",
    "<ts_10.55>",
    "<ts_10.60>",
    "<ts_10.65>",
    "<ts_10.70>",
    "<ts_10.75>",
    "<ts_10.80>",
    "<ts_10.85>",
    "<ts_10.90>",
    "<ts_10.95>",
    "<ts_11.00>",
    "<ts_11.05>",
    "<ts_11.10>",
    "<ts_11.15>",
    "<ts_11.20>",
    "<ts_11.25>",
    "<ts_11.30>",
    "<ts_11.35>",
    "<ts_11.40>",
    "<ts_11.45>",
    "<ts_11.50>",
    "<ts_11.55>",
    "<ts_11.60>",
    "<ts_11.65>",
    "<ts_11.70>",
    "<ts_11.75>",
    "<ts_11.80>",
    "<ts_11.85>",
    "<ts_11.90>",
    "<ts_11.95>",
    "<ts_12.00>",
    "<ts_12.05>",
    "<ts_12.10>",
    "<ts_12.15>",
    "<ts_12.20>",
    "<ts_12.25>",
    "<ts_12.30>",
    "<ts_12.35>",
    "<ts_12.40>",
    "<ts_12.45>",
    "<ts_12.50>",
    "<ts_12.55>",
    "<ts_12.60>",
    "<ts_12.65>",
    "<ts_12.70>",
    "<ts_12.75>",
    "<ts_12.80>",
    "<ts_12.85>",
    "<ts_12.90>",
    "<ts_12.95>",
    "<ts_13.00>",
    "<ts_13.05>",
    "<ts_13.10>",
    "<ts_13.15>",
    "<ts_13.20>",
    "<ts_13.25>",
    "<ts_13.30>",
    "<ts_13.35>",
    "<ts_13.40>",
    "<ts_13.45>",
    "<ts_13.50>",
    "<ts_13.55>",
    "<ts_13.60>",
    "<ts_13.65>",
    "<ts_13.70>",
    "<ts_13.75>",
    "<ts_13.80>",
    "<ts_13.85>",
    "<ts_13.90>",
    "<ts_13.95>",
    "<ts_14.00>",
    "<ts_14.05>",
    "<ts_14.10>",
    "<ts_14.15>",
    "<ts_14.20>",
    "<ts_14.25>",
    "<ts_14.30>",
    "<ts_14.35>",
    "<ts_14.40>",
    "<ts_14.45>",
    "<ts_14.50>",
    "<ts_14.55>",
    "<ts_14.60>",
    "<ts_14.65>",
    "<ts_14.70>",
    "<ts_14.75>",
    "<ts_14.80>",
    "<ts_14.85>",
    "<ts_14.90>",
    "<ts_14.95>",
    "<ts_15.00>",
    "<ts_15.05>",
    "<ts_15.10>",
    "<ts_15.15>",
    "<ts_15.20>",
    "<ts_15.25>",
    "<ts_15.30>",
    "<ts_15.35>",
    "<ts_15.40>",
    "<ts_15.45>",
    "<ts_15.50>",
    "<ts_15.55>",
    "<ts_15.60>",
    "<ts_15.65>",
    "<ts_15.70>",
    "<ts_15.75>",
    "<ts_15.80>",
    "<ts_15.85>",
    "<ts_15.90>",
    "<ts_15.95>",
    "<ts_16.00>",
    "<ts_16.05>",
    "<ts_16.10>",
    "<ts_16.15>",
    "<ts_16.20>",
    "<ts_16.25>",
    "<ts_16.30>",
    "<ts_16.35>",
    "<ts_16.40>",
    "<ts_16.45>",
    "<ts_16.50>",
    "<ts_16.55>",
    "<ts_16.60>",
    "<ts_16.65>",
    "<ts_16.70>",
    "<ts_16.75>",
    "<ts_16.80>",
    "<ts_16.85>",
    "<ts_16.90>",
    "<ts_16.95>",
    "<ts_17.00>",
    "<ts_17.05>",
    "<ts_17.10>",
    "<ts_17.15>",
    "<ts_17.20>",
    "<ts_17.25>",
    "<ts_17.30>",
    "<ts_17.35>",
    "<ts_17.40>",
    "<ts_17.45>",
    "<ts_17.50>",
    "<ts_17.55>",
    "<ts_17.60>",
    "<ts_17.65>",
    "<ts_17.70>",
    "<ts_17.75>",
    "<ts_17.80>",
    "<ts_17.85>",
    "<ts_17.90>",
    "<ts_17.95>",
    "<ts_18.00>",
    "<ts_18.05>",
    "<ts_18.10>",
    "<ts_18.15>",
    "<ts_18.20>",
    "<ts_18.25>",
    "<ts_18.30>",
    "<ts_18.35>",
    "<ts_18.40>",
    "<ts_18.45>",
    "<ts_18.50>",
    "<ts_18.55>",
    "<ts_18.60>",
    "<ts_18.65>",
    "<ts_18.70>",
    "<ts_18.75>",
    "<ts_18.80>",
    "<ts_18.85>",
    "<ts_18.90>",
    "<ts_18.95>",
    "<ts_19.00>",
    "<ts_19.05>",
    "<ts_19.10>",
    "<ts_19.15>",
    "<ts_19.20>",
    "<ts_19.25>",
    "<ts_19.30>",
    "<ts_19.35>",
    "<ts_19.40>",
    "<ts_19.45>",
    "<ts_19.50>",
    "<ts_19.55>",
    "<ts_19.60>",
    "<ts_19.65>",
    "<ts_19.70>",
    "<ts_19.75>",
    "<ts_19.80>",
    "<ts_19.85>",
    "<ts_19.90>",
    "<ts_19.95>",
    "<ts_20.00>",
]

vocab_size = 10000
print("="*50)
print(f"Training tokenizers with vocab size {vocab_size} token")
print("="*50)
input_txt = r"D:\chuyen_nganh\ASRProject\Tokenizer\text2tokenizer_filtered.txt"
spm.SentencePieceTrainer.train(
    input=input_txt, # file txt
    model_prefix=f"unigram_{vocab_size}",
    vocab_size=vocab_size,
    model_type='unigram',
    unk_id=0,
    bos_id=1,
    eos_id=2,
    pad_id=3,
    user_defined_symbols=control_tokens
)
print("Traning hoàn tất")
print("\nLoad file text kiểm thử...")
with open(input_txt, 'r', encoding='utf-8') as f:
    sentences = [line.strip() for line in f if line.strip()]
    
total_chars = sum(len(s) for s in sentences)
print(f"Total sentences: {len(sentences)}")
print(f"Total characters: {total_chars:,}")

print("Load model...")
sp = spm.SentencePieceProcessor(model_file=f"unigram_{vocab_size}.model")
tokens_per_sentence = [len(sp.encode(s, out_type=str)) for s in sentences]

print("Load model thành công, bắt đầu tính toán")
total_tokens = sum(tokens_per_sentence)
avg_tokens = np.mean(tokens_per_sentence)
median_tokens = np.median(tokens_per_sentence)

compression_ratio = total_chars / total_tokens
std_tokens = np.std(tokens_per_sentence)
min_tokens = min(tokens_per_sentence)
max_tokens = max(tokens_per_sentence)

print(f"  Total tokens: {total_tokens:,}")
print(f"  Avg tokens/sentence: {avg_tokens:.2f}")
print(f"  Median tokens/sentence: {int(median_tokens)}")
print(f"  Token std dev: {std_tokens:.2f}")
print(f"  Token range: [{min_tokens}, {max_tokens}]")
print(f"  Compression ratio: {compression_ratio:.4f} (chars/token)")